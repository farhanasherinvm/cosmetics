
<!DOCTYPE html>
<html lang="en">
<head>
	<title> {% block title %} Shop {% endblock %}</title>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
    

<!--===============================================================================================-->	
	<link rel="icon" type="image/png" href="{% static 'user\assets\images\icons\favicon.png' %}"/>
<!--===============================================================================================-->
	<link rel="stylesheet" type="text/css" href="{% static 'user\assets\vendor\bootstrap\css\bootstrap.min.css' %}">
<!--===============================================================================================-->
	<link rel="stylesheet" type="text/css" href="{% static 'user\assets\fonts\font-awesome-4.7.0\css\font-awesome.min.css' %}">
<!--===============================================================================================-->
	<link rel="stylesheet" type="text/css" href="{% static 'user\assets\fonts\iconic\css\material-design-iconic-font.min.css' %}">
<!--===============================================================================================-->
	<link rel="stylesheet" type="text/css" href="{% static 'user\assets\fonts\linearicons-v1.0.0\icon-font.min.css' %}">
<!--===============================================================================================-->
	<link rel="stylesheet" type="text/css" href="{% static 'user\assets\vendor\animate\animate.css' %}">
<!--===============================================================================================-->	
	<link rel="stylesheet" type="text/css" href="{% static 'user\assets\vendor\css-hamburgers\hamburgers.min.css' %}">
<!--===============================================================================================-->
	<link rel="stylesheet" type="text/css" href="{% static 'user\assets\vendor\css-hamburgers\hamburgers.min.css' %}">
<!--===============================================================================================-->
	<link rel="stylesheet" type="text/css" href="{% static 'user\assets\vendor\select2\select2.min.css' %}">
<!--===============================================================================================-->	
	<link rel="stylesheet" type="text/css" href="{% static 'user\assets\vendor\daterangepicker\daterangepicker.css' %}">
<!--===============================================================================================-->
	<link rel="stylesheet" type="text/css" href="{% static 'user\assets\vendor\slick\slick.css' %}">
<!--===============================================================================================-->
	<link rel="stylesheet" type="text/css" href="{% static 'user\assets\vendor\MagnificPopup\magnific-popup.css' %}">
<!--===============================================================================================-->
	<link rel="stylesheet" type="text/css" href="{% static 'user\assets\vendor\perfect-scrollbar\perfect-scrollbar.css' %}">
<!--===============================================================================================-->
	<link rel="stylesheet" type="text/css" href="{% static 'user\assets\css\util.css' %}">
	<link rel="stylesheet" type="text/css" href="{% static 'user\assets\css\main.css' %}">
<!--===============================================================================================-->
    <!-- Add SweetAlert library -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@10"></script>
<!--===============================================================================================-->

<link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" crossorigin="anonymous">

<!-- Include the PayPal JavaScript SDK -->
<script src="https://www.paypal.com/sdk/js?client-id=AepSdEgnLb5ksacJ0CoS2bG1flWKr3kQevJcP3NtsPqBr5KJgKVcJlSPpjkogITKDmpL-HHfHiHSEEQk&currency=USD"></script>

 <!-- Add these links in your HTML head section -->
{% comment %} <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css"> {% endcomment %}
<link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" integrity="sha384-B4gt1jrGC7Jh4AgTPSdUtOBvfO8sh+WyIo1mLx4e7xj" crossorigin="anonymous">

<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.16.0/umd/popper.min.js"></script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script> 




</head>
<script>
    .swal-toast {
      
      top: 150px; /* Adjust the top position according to your layout */
      z-index: 9999;  /* Adjust the top position according to your layout */
    }
  </script>
  
  
    <!-- breadcrumb -->
    <div class="container">
      <div class="bread-crumb flex-w p-l-25 p-r-15 p-t-30 p-lr-0-lg">
        <div class='flex-w m-t-130 w-full'>
        <a href="{% url 'home_app:home' %}" class="stext-109 cl8 hov-cl1 trans-04">
          Home
          <i class="fa fa-angle-right m-l-9 m-r-10" aria-hidden="true"></i>
        </a>
        <a href="{% url 'outgoing_app:checkout' %}" class="stext-109 cl8 hov-cl1 trans-04">
          Checkout
          <i class="fa fa-angle-right m-l-9 m-r-10" aria-hidden="true"></i>
        </a>
        <span class="stext-109 cl4">Payment</span>
      </div>
      </div>
    </div>
  
  
  
     <!--  Payment Details Right starts -->
    <div class="container">
      <div class="row">
        <div class="col-lg-10 col-xl-7 m-lr-auto m-b-50">
          <div class="card m-l-25 m-r--38 m-lr-0-xl" style="font-family: Poppins-Medium">
            <div class="card-body">
              <h4 class="card-title">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" class="bi bi-credit-card-2-front-fill" viewBox="0 0 16 16">
                  <path d="M0 4a2 2 0 0 1 2-2h12a2 2 0 0 1 2 2v8a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2zm2.5 1a.5.5 0 0 0-.5.5v1a.5.5 0 0 0 .5.5h2a.5.5 0 0 0 .5-.5v-1a.5.5 0 0 0-.5-.5zm0 3a.5.5 0 0 0 0 1h5a.5.5 0 0 0 0-1zm0 2a.5.5 0 0 0 0 1h1a.5.5 0 0 0 0-1zm3 0a.5.5 0 0 0 0 1h1a.5.5 0 0 0 0-1zm3 0a.5.5 0 0 0 0 1h1a.5.5 0 0 0 0-1zm3 0a.5.5 0 0 0 0 1h1a.5.5 0 0 0 0-1z"/>
                </svg>
                <i class="bi bi-credit-card-2-front-fill"></i> Payment Options
              </h4>
              <hr />
              <br>
              
              <div class="form-group row">
                <div class="col-sm-8">
                  <h4 id="user_name" name="user_name"> order.user_name </h4>
                </div>
              </div>
              
              
              <div class="form-group row">
                <div class="col-sm-8">
                  <h5>Order Number:</h5>
              </div>
            
              
              <div class="form-group row">
                <div class="col-sm-8">
                  <p> order.phone</p>
                  <p>order.address_1</p>
                  <p> order.city/ order.state /order.country</p>
                </div>
              </div>
              
              <hr />
              
              <div class="form-group row">
                {% for cart_item in cart_items %}
                <div class="col-sm-8">
                  Items:
                  <br>{{ cart_item.product.product_name }}
                  <ul>
                    <p style="font-size: 12px;">
                      {% if cart_item.product_variant.all %}
                          {% for item in cart_item.product_variant.all %}
                              {% if item.variant_types == 'color' %}
                                  {{ item.variant_types | capfirst }}: {{ item.variant_value }}<br>
                              {% endif %}
                          {% endfor %}
                          {% for item in cart_item.product_variant.all %}
                              {% if item.variant_types == 'size' %}
                                  {{ item.variant_types | capfirst }}: {{ item.variant_value }}<br>
                              {% endif %}
                          {% endfor %}
                      {% endif %}
                      Quantity:
                    </p>
                  </ul>
                </div>
                {% endfor %}
              </div>
              
              <hr>
              
              <div class="row">
                <div class="col-sm-6">
                  <div class="card">
                    <div class="card-body">
                      <h5 class="card-title">Cash on Delivery</h5>
                      <br>
                      <p class="card-text">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-cash-coin" viewBox="0 0 16 16">
                          <path fill-rule="evenodd" d="M11 15a4 4 0 1 0 0-8 4 4 0 0 0 0 8m5-4a5 5 0 1 1-10 0 5 5 0 0 1 10 0" />
                          <path d="M9.438 11.944c.047.596.518 1.06 1.363 1.116v.44h.375v-.443c.875-.061 1.386-.529 1.386-1.207 0-.618-.39-.936-1.09-1.1l-.296-.07v-1.2c.376.043.614.248.671.532h.658c-.047-.575-.54-1.024-1.329-1.073V8.5h-.375v.45c-.747.073-1.255.522-1.255 1.158 0 .562.378.92 1.007 1.066l.248.061v1.272c-.384-.058-.639-.27-.696-.563h-.668zm1.36-1.354c-.369-.085-.569-.26-.569-.522 0-.294.216-.514.572-.578v1.1h-.003zm.432.746c.449.104.655.272.655.569 0 .339-.257.571-.709.614v-1.195l.054.012z" />
                          <path d="M1 0a1 1 0 0 0-1 1v8a1 1 0 0 0 1 1h4.083c.058-.344.145-.678.258-1H3a2 2 0 0 0-2-2V3a2 2 0 0 0 2-2h10a2 2 0 0 0 2 2v3.528c.38.34.717.728 1 1.154V1a1 1 0 0 0-1-1z" />
                          <path d="M9.998 5.083 10 5a2 2 0 1 0-3.132 1.65 5.982 5.982 0 0 1 3.13-1.567z" />
                        </svg>
                        <i class="bi bi-cash-coin"></i>
                        <span class="align-middle">Pay with cash on delivery</span>
                      </p>
                      <br />
                      <a href="" class="flex-c-m stext-101 cl0 size-112 bg3 bor14 p-lr-15 trans-04 pointer" style="color: white;">Cash on Delivery</a>
                    </div>
                  </div>
                </div>
                
                <div class="col-sm-6">
                  <div class="card">
                    <div class="card-body">
                      <h5 class="card-title">Wallet Delivery</h5>
                      <br>
                      <p class="card-text">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-cash-coin" viewBox="0 0 16 16">
                          <path fill-rule="evenodd" d="M11 15a4 4 0 1 0 0-8 4 4 0 0 0 0 8m5-4a5 5 0 1 1-10 0 5 5 0 0 1 10 0" />
                          <path d="M9.438 11.944c.047.596.518 1.06 1.363 1.116v.44h.375v-.443c.875-.061 1.386-.529 1.386-1.207 0-.618-.39-.936-1.09-1.1l-.296-.07v-1.2c.376.043.614.248.671.532h.658c-.047-.575-.54-1.024-1.329-1.073V8.5h-.375v.45c-.747.073-1.255.522-1.255 1.158 0 .562.378.92 1.007 1.066l.248.061v1.272c-.384-.058-.639-.27-.696-.563h-.668zm1.36-1.354c-.369-.085-.569-.26-.569-.522 0-.294.216-.514.572-.578v1.1h-.003zm.432.746c.449.104.655.272.655.569 0 .339-.257.571-.709.614v-1.195l.054.012z" />
                          <path d="M1 0a1 1 0 0 0-1 1v8a1 1 0 0 0 1 1h4.083c.058-.344.145-.678.258-1H3a2 2 0 0 0-2-2V3a2 2 0 0 0 2-2h10a2 2 0 0 0 2 2v3.528c.38.34.717.728 1 1.154V1a1 1 0 0 0-1-1z" />
                          <path d="M9.998 5.083 10 5a2 2 0 1 0-3.132 1.65 5.982 5.982 0 0 1 3.13-1.567z" />
                        </svg>
                        <i class="bi bi-cash-coin"></i>
                        <span class="align-middle">Pay with your Wallet Amount</span>
                      </p>
                      <br />
                      {% comment %} <a href="" class="flex-c-m stext-101 cl0 size-112 bg3 bor14 p-lr-15 trans-04 pointer" style="color: white;">Wallet Payment</a> {% endcomment %}
                      <button id="wallet-payment-btn" type="button" class="flex-c-m stext-101 cl0 size-116 bg3 bor14 p-lr-15 trans-04 pointer" style="color: white;     margin-left: 0px;
                      height: 42px;">Wallet Payment</button>
  
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
     
    
    <!--  Paypal payment Details Right starts -->
    <div class="col-sm-10 col-lg-7 col-xl-5 m-lr-auto m-b-50">
      <div class="card bor10 p-lr-40 p-t-30 p-b-40 m-l-63 m-r-40 m-lr-0-xl p-lr-15-sm">
        <form class="coupon-form"  id="coupon-form" method="POST">
          {% csrf_token %}
          <input type="text" id="coupon-input" name="coupon_code" placeholder="Coupon code" class="flex-c-m cl0 size-116 bg3 bor14 p-lr-15" style="color: black; background-color: #f7f7f7; height: 44px; font-family: Poppins-Medium; text-align: center;">
          <br>
          <button type="submit" class="flex-c-m stext-101 cl0 size-116 bg3 bor14 p-lr-15 trans-04 pointer apply-button" id="apply-coupon-btn" style="color: white; height: 44px;">Apply coupon</button>
        </form>
        <br>
        <h4 class="mtext-109 cl2 p-b-30">Price Details</h4>
    
        <div class="flex-w flex-t bor12 p-t-15 p-b-30">
          <div class="size-208">
            <span class="stext-110 cl2">Total Price:</span>
          </div>
          <div class="size-209" id="price-items">
            <span class="mtext-110 cl2">₹ total</span>
          </div>
        </div>
    
        <div class="flex-w flex-t bor12 p-t-15 p-b-30">
          <div class="size-208">
            <span class="stext-110 cl2">Delivery Charge:</span>
          </div>
          <div class="size-209" id="price-shipping">
            <span class="mtext-110 cl2">₹shipping </span>
          </div>
        </div>
    
        <div class="flex-w flex-t bor12 p-t-15 p-b-30">
          <div class="size-208">
            <span class="stext-110 cl2">Tax:</span>
          </div>
          <div class="size-209" id="price-tax">
            <span class="mtext-110 cl2">₹ tax </span>
          </div>
        </div>
        
        <div class="flex-w flex-t bor12 p-t-15 p-b-30" >
          <div class="size-208">
            <span class="stext-110 cl2">Coupon:</span>
          </div>
          <div class="size-209"  id="coupon-price">
            <span class="mtext-110 cl2">₹ coupon </span>
          </div>
        </div>
    
        <div class="flex-w flex-t p-t-27 p-b-33">
          <div class="size-208">
            <span class="mtext-101 cl2">Amount Payable:</span>
          </div>
          <div class="size-209 p-t-1" id="grand-total">
            <span class="mtext-110 cl2">₹grand_total </span>
          </div>
        </div>
    
        <div class="p-t-40">
          <div class="flex-c-m flex-w p-b-18">
            <a href="#" class="m-all-1"><img src="{% static 'user\assets\images\icons\icon-pay-01.png' %}" alt="ICON-PAY" /></a>
            <a href="#" class="m-all-1"><img src="{% static 'user\assets\images\icons\icon-pay-02.png' %}" alt="ICON-PAY" /></a>
            <a href="#" class="m-all-1"><img src="{% static 'user\assets\images\icons\icon-pay-03.png' %}" alt="ICON-PAY" /></a>
            <a href="#" class="m-all-1"><img src="{% static 'user\assets\images\icons\icon-pay-04.png' %}" alt="ICON-PAY" /></a>
            <a href="#" class="m-all-1"><img src="{% static 'user\assets\images\icons\icon-pay-05.png' %}" alt="ICON-PAY" /></a>
          </div>
          
          <div id="paypal-button-container">
            <!-- Paypal button loads here -->
          </div>
        </div>
      </div>
    </div>
  
  </div>
  </div>
  
  
  <!-- Coupon Success -->
  <script src="https://code.jquery.com/jquery-3.6.4.min.js"></script>
  
  
  <!-- Paypal -->
  <script>
    function getCookie(name) {
      var cookieValue = null;
      if (document.cookie && document.cookie !== '') {
          var cookies = document.cookie.split(';');
          for (var i = 0; i < cookies.length; i++) {
              var cookie = cookies[i].trim();
              if (cookie.substring(0, name.length + 1) === (name + '=')) {
                  cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                  break;
              }
          }
      }
      return cookieValue;
  }
  
    // Render the PayPal button into #paypal-button-container
    var couponApplied = false;  // Add a variable to track whether the coupon is applied
    var originalAmount = {{ grand_total }};
    var amount = originalAmount;
  
    var url = "{% url 'order_app:payments' %}";
    var csrftoken = getCookie('csrftoken');
    var orderID = "{{ order.order_number }}"
    var payment_method = "PayPal"
    var redirect_url = "{% url 'order_app:order_complete' %}";
  
    paypal.Buttons({
        style: {
            color: 'blue',
            shape: 'pill',
            label: 'pay',
            height: 40
        },
  
        // Call your server to set up the transaction
        createOrder: function(data, actions) {
            return actions.order.create({
                purchase_units: [{
                    amount: {
                        value: amount,
                    }
                }]
            })
        },
  
        // Call your server to finalize the transaction
        onApprove: function(data, actions) {
            return actions.order.capture().then(function(details) {
                //alert('Transaction completed by ' + details.payer.name.given_name + '|');
                console.log(details),
                Swal.fire({
                    icon: "success",
                    title: "Transaction completed",  // Display the message text as the title
                    toast: true,
                    position: "center-end",
                    showConfirmButton: false,
                    timer: 3000,
                    timerProgressBar: true,
                    customClass: {
                      popup: 'swal-toast',
                      position: 'center',
                    },
                    appendTo: 'body',
                    didOpen: (toast) => {
                        toast.addEventListener("mouseenter", Swal.stopTimer);
                        toast.addEventListener("mouseleave", Swal.resumeTimer);
                    }
                });
  
                sendData();
                function sendData() {
                    fetch(url, {
                            method: "POST",
                            headers: {
                                "Content-type": "application/json",
                                "X-CSRFToken": csrftoken,
                            },
                            body: JSON.stringify({
                                orderID: orderID,
                                transID: details.id,
                                payment_method: payment_method,
                                status: details.status,
                            }),
                        })
                        .then((response) => response.json())
                        .then((data) => {
                            window.location.href = redirect_url + '?order_number=' + data.order_number + '&payment_id=' + data.transID;
  
                        })
                }
            });
        }
  
    }).render('#paypal-button-container');
  
    // Function to update the PayPal button amount after applying the coupon
    function updatePayPalAmount(newAmount) {
        amount = newAmount;
        
    }
  </script>
  
  
  
  
  <!-- Update the coupon amount after applying the coupon -->
  <script>
    $(document).ready(function() {
        $("#coupon-form").on("submit", function(e) {
            e.preventDefault()
            var couponValue =  $("#coupon-input").val();
  
            $.ajax({
                type: "POST",
                url: "{% url 'order_app:apply_coupon' %}",
                data: {
                    'coupon': couponValue
                },
                dataType: "json",
                headers: {
                    "X-CSRFToken": getCookie("csrftoken")
                },
                success: function(response) {
                    if ('error' in response) {
                        console.log("Error:", response.error);
                        $("#error-message").text(response.error);
                        Swal.fire({
                            icon: "error",
                            title: "Error",
                            text: response.error,
                        });
                    }
  
                    if ('success' in response) {
                        console.log("Success:", response.success);
                        Swal.fire({
                            icon: "success",
                            title: "Success",
                            text: response.success,
                        });
  
                        updatePriceDetails(response);
                        // Update the PayPal button amount after applying the coupon
                        updatePayPalAmount(response.grand_total);
                        $("#error-message").text('');
                    }
                },
  
                // ... (your existing error handling)
            });
        });
  
        // Function to update price details on the page
        function updatePriceDetails(data) {
            // Update the price details using the received data
            $("#total-price").html("<strong style=\"font-family: 'Arial', 'Helvetica', sans-serif;\">&#8377;</strong>" + data.total);
            var couponHtml = "<strong style=\"font-family: 'Arial', 'Helvetica', sans-serif;\">&#8377;</strong>" + "-" + Math.abs(data.coupon);
            $("#coupon-price").html(couponHtml);
            $("#tax-price").html("<strong style=\"font-family: 'Arial', 'Helvetica', sans-serif;\">&#8377;</strong>" + data.tax);
            $("#shipping-price").html("<strong style=\"font-family: 'Arial', 'Helvetica', sans-serif;\">&#8377;</strong>" + data.shipping);
            $("#grand-total").html("<strong style=\"font-family: 'Arial', 'Helvetica', sans-serif;\">&#8377;</strong>" + data.grand_total);
        }
    });
  </script>
  
  
  <script>
    $(document).ready(function () {
        // Handle Wallet Payment button click
        $("#wallet-payment-btn").on("click", function () {
            // Perform AJAX request for wallet payment
            $.ajax({
                type: "POST",
                url: "{% url 'order_app:wallet_payment' order.order_number %}",
                dataType: "json",
                headers: { "X-CSRFToken": getCookie("csrftoken") },
                success: function (response) {
                    console.log("successResponse:", response);
                    
                    if ('success' in response) {
                        console.log("Success:", response.success);
                        // Display a success message to the user
                        Swal.fire({
                            icon: "success",
                            title: "Success",
                            text: response.message,
                        });
                        window.location.href = "{% url 'order_app:success'  %}";
                        // Update the relevant parts of the page with the response
                        // Add logic to update the UI based on the wallet payment response
                        // (e.g., show a success message, update order status, etc.)
                    }
                    
                    if ('error' in response) {
                        console.log("Error:", response.error);
                        // Display an error message to the user
                        Swal.fire({
                            icon: "error",
                            title: "Error",
                            text: response.error,
                        });
                    }
    
  
                },
                error: function (xhr, status, error) {
                    console.log("AJAX Error:", status, error);
                    // Provide a generic error message to the user
                    Swal.fire({
                        icon: "error",
                        title: "AJAX Error",
                        text: 'An error occurred while processing your request. Please try again.',
                    });
                }
            });
        });
    });
  </script>